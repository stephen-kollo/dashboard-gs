<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" >

    <div class="upload-settings d-flex justify-content-between">
      <div class="w-50">
        <select id="week-select" class="form-select" aria-label=".form-select-sm example">
          <option selected>Select Week</option>
          <option value="week 1">Week 1</option>
          <option value="week 2">Week 2</option>
          <option value="week 3">Week 3</option>
          <option value="week 4">Week 4</option>
          <option value="week 5">Week 5</option>
          <option value="week 6">Week 6</option>
          <option value="week 7">Week 7</option>
          <option value="week 8">Week 8</option>
          <option value="week 9">Week 9</option>
          <option value="week 10">Week 10</option>
          <option value="week 11">Week 11</option>
          <option value="week 12">Week 12</option>
          <option value="week 13">Week 13</option>
        </select>
      </div>

      <br>

      <div class="w-50">
        <select id="qtr-select" class="form-select" aria-label=".form-select-sm example">
          <option selected>Select QTR</option>
          <option value="2022 / 1">2022 / 1</option>
          <option value="2022 / 2">2022 / 2</option>
          <option value="2022 / 3">2022 / 3</option>
          <option value="2022 / 4">2022 / 4</option>
          <option value="2023 / 1">2023 / 1</option>
        </select>
      </div>
    </div>

    <div style="border-top: 1px solid grey; margin-top: 15px;"></div>
    <br>

    <form>
      <label id="label-RecallSuccess" for="RecallSuccess" class="form-label">Recall Success</label>
      <input class="form-control form-control-sm" id="RecallSuccess" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'RecallSuccess')" name="file">
    </form>

    <br>

    <form>
      <label id="label-DiaryNewPatientsBranch" for="DiaryNewPatientsBranch" class="form-label">Diary New Patients Branch</label>
      <input class="form-control form-control-sm" id="DiaryNewPatientsBranch" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'DiaryNewPatientsBranch')" name="file">
    </form>

    <br>
    
    <form>
      <label id="label-BranchKpiSummaryData" for="BranchKpiSummaryData" class="form-label">Branch KPI Summary</label>
      <input class="form-control form-control-sm" id="BranchKpiSummaryData" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'BranchKpiSummaryData')" name="file">
    </form>

    <br>
    
    <form>
      <label id="label-PatientTransactions" for="PatientTransactions" class="form-label">Patient Transactions</label>
      <input class="form-control form-control-sm" id="PatientTransactions" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'PatientTransactions')" name="file">
    </form>

    <br>
    
    <form>
      <label id="label-AppointmentsByBookingDate" for="AppointmentsByBookingDate" class="form-label">Appointments By Booking Date</label>
      <input class="form-control form-control-sm" id="AppointmentsByBookingDate" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'AppointmentsByBookingDate')" name="file">
    </form>

    <br>
    
    <form>
      <label id="label-WhyUs" for="WhyUs" class="form-label">Why Us</label>
      <input class="form-control form-control-sm" id="WhyUs" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'WhyUs')" name="file">
    </form>
    
    <br>

    <form>
      <label id="label-AppTypeByOptom" for="AppTypeByOptom" class="form-label">App Type By Optom</label>
      <input class="form-control form-control-sm" id="AppTypeByOptom" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'AppTypeByOptom')" name="file">
    </form>
    
    <br>

    <form>
      <label id="label-ProductSalesbyBrand" for="ProductSalesbyBrand" class="form-label">Product Sales by Brand</label>
      <input class="form-control form-control-sm" id="ProductSalesbyBrand" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'ProductSalesbyBrand')" name="file">
    </form>

    <br>
    
    <form>
      <label id="label-DiaryRecallUnchanged" for="DiaryRecallUnchanged" class="form-label">Diary Recall Unchanged</label>
      <input class="form-control form-control-sm" id="DiaryRecallUnchanged" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'DiaryRecallUnchanged')" name="file">
    </form>
    
    <br>

    <form>
      <label id="label-TillOpticianPerformanceAnalysis" for="TillOpticianPerformanceAnalysis" class="form-label">Till Optician Performance Analysis</label>
      <input class="form-control form-control-sm" id="TillOpticianPerformanceAnalysis" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'TillOpticianPerformanceAnalysis')" name="file">
    </form>
    
    <br>

    <form>
      <label id="label-SchemeAnalysis" for="SchemeAnalysis" class="form-label">Scheme Analysis</label>
      <input class="form-control form-control-sm" id="SchemeAnalysis" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'SchemeAnalysis')" name="file">
    </form>

    <br>
    
    <form>
      <label id="label-takings(current)Data" for="takings(current)Data" class="form-label">Takings Data</label>
      <input class="form-control form-control-sm" id="takings(current)Data" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'takings(current)Data')" name="file">
    </form>
    
    <br>

    <form>
      <label id="label-debtors(current)Data" for="debtors(current)Data" class="form-label">Debtors Data</label>
      <input class="form-control form-control-sm" id="debtors(current)Data" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'debtors(current)Data')" name="file">
    </form>
    
    <br>

    <form>
      <label id="label-TillSales" for="TillSales" class="form-label">Till Sales</label>
      <input class="form-control form-control-sm" id="TillSales" type="file" accept=".csv,text/csv, .xls, .xslx" onchange="importFile(this.parentNode, 'TillSales')" name="file">
    </form>

    <script>

    function getPeriod() {
      let week = document.getElementById('week-select').value
      let qtr = document.getElementById('qtr-select').value

      if (week == "Select Week" || qtr == "Select QTR") {
        return false
      } else {
        console.log(
          {
          week: week,
          qtr: qtr
        }
        )
        return {
          week: week,
          qtr: qtr
        }
      }
    }

    function importFile(e, doc_name) {
      const period = getPeriod()
      if(period == false) {
        console.log("Please select Week and QTR")
        return
      }
      if(document.getElementById(doc_name).files[0].name.includes('.csv')) {
        file = e.file.files[0];
        const f = new FileReader();
        f.onload = d => google.script.run.withSuccessHandler(displaySuccess).importFile([[...new Int8Array(d.target.result)], file.type, file.name], doc_name, period);
        f.readAsArrayBuffer(file);
      } else {
        processExcel(document.getElementById(doc_name).files[0], doc_name, period)
      }
    }

    function processExcel(file, doc_name, period){
      try {
        var reader = new FileReader();
        reader.readAsBinaryString(file);
        reader.onload = function(e) {
            var data = e.target.result;
            var workbook = XLSX.read(data, {
                type : 'binary'
            }); 
            var roa = XLSX.utils.sheet_to_csv(workbook.Sheets[workbook.SheetNames[0]]);
            google.script.run.withSuccessHandler(displaySuccess).importFile(XLSX.utils.sheet_to_csv(workbook.Sheets[workbook.SheetNames[0]]), doc_name, period);
            }
      } catch(e) {
        console.error(e);
      }       
    }

    function displaySuccess(res) {
      console.log(res)
      document.getElementById(`label-${res}`).style = "color: green"
      google.script.host.close
    }
    </script>
  </body>
</html>
